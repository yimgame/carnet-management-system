<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Carnets - ARCOR</title>
    
    <!-- Link din√°mico para el tema CSS -->
    <link id="theme-stylesheet" rel="stylesheet" href="themes/default.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            color: #1e3a8a;
            font-size: 28px;
        }

        .buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1e40af;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .alerts-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .alerts-section h2 {
            color: #856404;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-item {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 4px solid #dc2626;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-item.warning {
            border-left-color: #f59e0b;
        }

        .alert-item.expired {
            border-left-color: #dc2626;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .carnet-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .carnet-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: #1e3a8a;
        }

        .carnet-card.expired::before {
            background: #dc2626;
        }

        .carnet-card.warning::before {
            background: #f59e0b;
        }

        .carnet-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .photo-placeholder {
            width: 80px;
            height: 80px;
            background: #e5e7eb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .carnet-info {
            flex: 1;
        }

        .carnet-info h3 {
            color: #1e3a8a;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .carnet-info p {
            color: #6b7280;
            font-size: 14px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .detail-label {
            font-weight: 600;
            color: #4b5563;
        }

        .detail-value {
            color: #1f2937;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #1e3a8a;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4b5563;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2563eb;
        }

        #fileInput {
            padding: 5px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #1e3a8a;
        }

        .stat-label {
            color: #6b7280;
            margin-top: 5px;
        }

        .filter-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            flex: 1;
            min-width: 200px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            background: white;
            border-radius: 10px;
        }

        /* Estilos para botones de impresi√≥n */
        .print-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-info {
            background: #3b82f6;
            color: white;
        }

        .btn-info:hover {
            background: #2563eb;
        }

        /* Modal de configuraci√≥n de impresi√≥n */
        .print-config {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .config-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }

        .config-row label {
            font-weight: 600;
            min-width: 150px;
        }

        .config-row select,
        .config-row input {
            flex: 1;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
        }

        /* Vista previa de carnets */
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            background: #f3f4f6;
            border-radius: 10px;
        }

        .carnet-preview {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            padding: 10px;
            font-size: 11px;
            page-break-inside: avoid;
        }

        .carnet-preview-header {
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-weight: bold;
            font-size: 9px;
            margin: -10px -10px 10px -10px;
            border-radius: 5px 5px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            letter-spacing: 0.3px;
        }

        .carnet-preview-content {
            display: grid;
            grid-template-columns: 60px 1fr;
            gap: 10px;
        }

        .carnet-preview-photo {
            width: 60px;
            height: 60px;
            background: #e5e7eb;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .carnet-preview-info {
            font-size: 9px;
        }

        .carnet-preview-info p {
            margin: 3px 0;
        }

        .carnet-preview-info strong {
            display: inline-block;
            width: 80px;
        }

        .carnet-preview-footer {
            margin-top: 10px;
            padding: 8px;
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            color: white;
            text-align: center;
            font-size: 7px;
            font-weight: bold;
            letter-spacing: 0.5px;
            margin: 10px -10px -10px -10px;
            border-radius: 0 0 5px 5px;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöó Sistema de Gesti√≥n de Carnets - ARCOR</h1>
            <div class="buttons">
                <button class="btn btn-warning" onclick="openExcelUpload()">üìÇ Cargar Excel</button>
                <button class="btn btn-success" onclick="openNewCarnetForm()">‚ûï Nuevo Carnet</button>
                <button class="btn btn-primary" onclick="exportData()">üíæ Exportar Datos</button>
                <button class="btn btn-info" onclick="openPrintConfig()">üñ®Ô∏è Configurar</button>
                <button class="btn btn-info" onclick="printQuick10()" style="background: #8b5cf6;">üñ®Ô∏è 10 por Hoja</button>
                <button class="btn btn-secondary" onclick="openThemeConfig()" title="Cambiar tema">üé® Temas</button>
            </div>
        </header>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalCarnets">0</div>
                <div class="stat-label">Total Carnets</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeCount">0</div>
                <div class="stat-label">Vigentes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="warningCount">0</div>
                <div class="stat-label">Por Vencer (30 d√≠as)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="expiredCount">0</div>
                <div class="stat-label">Vencidos</div>
            </div>
        </div>

        <div class="alerts-section" id="alertsSection" style="display: none;">
            <h2>‚ö†Ô∏è Alertas de Vencimiento</h2>
            <div id="alertsList"></div>
        </div>

        <div class="filter-section">
            <div class="filter-group">
                <input type="text" id="searchInput" placeholder="üîç Buscar por nombre, apellido o DNI...">
                <select id="statusFilter">
                    <option value="all">Todos los estados</option>
                    <option value="active">Vigentes</option>
                    <option value="warning">Por vencer</option>
                    <option value="expired">Vencidos</option>
                </select>
                <button class="btn btn-primary" onclick="filterCarnets()">Filtrar</button>
            </div>
        </div>

        <div class="cards-grid" id="carnetsGrid"></div>
        <div class="no-data" id="noData" style="display: none;">
            No hay carnets registrados. Carga un archivo Excel o agrega uno nuevo.
        </div>
    </div>

    <!-- Modal para cargar Excel -->
    <div class="modal" id="excelModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cargar Archivo Excel</h2>
                <button class="close-btn" onclick="closeModal('excelModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Seleccionar archivo Excel (.xlsx, .xls)</label>
                <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="loadExcel(event)">
            </div>
            <p style="color: #6b7280; font-size: 14px; margin-top: 15px;">
                El archivo debe contener las columnas: Apellido, Nombre, DNI, Legajo, Fecha_Calificacion, Fecha_Vencimiento, Apto_Medico
            </p>
        </div>
    </div>

    <!-- Modal para configuraci√≥n de impresi√≥n -->
    <div class="modal" id="printConfigModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üñ®Ô∏è Configuraci√≥n de Impresi√≥n de Carnets</h2>
                <button class="close-btn" onclick="closeModal('printConfigModal')">&times;</button>
            </div>
            
            <div class="print-config">
                <div class="config-row">
                    <label>Carnets por hoja:</label>
                    <select id="carnetsPerPage" onchange="updatePreview()">
                        <option value="2">2 carnets (grande)</option>
                        <option value="4">4 carnets (mediano)</option>
                        <option value="6">6 carnets (compacto)</option>
                        <option value="8">8 carnets (peque√±o)</option>
                        <option value="10" selected>10 carnets (muy compacto)</option>
                    </select>
                </div>
                
                <div class="config-row">
                    <label>Orientaci√≥n:</label>
                    <select id="pageOrientation" onchange="updatePreview()">
                        <option value="portrait" selected>Vertical (Portrait)</option>
                        <option value="landscape">Horizontal (Landscape)</option>
                    </select>
                </div>

                <div class="config-row">
                    <label>Carnets a imprimir:</label>
                    <select id="carnetsToPrint" onchange="updatePreview()">
                        <option value="all">Todos los carnets</option>
                        <option value="active">Solo vigentes</option>
                        <option value="warning">Solo por vencer</option>
                        <option value="expired">Solo vencidos</option>
                    </select>
                </div>

                <div class="config-row">
                    <label>Incluir logo ARCOR:</label>
                    <input type="checkbox" id="includeLogo" checked onchange="updatePreview()">
                </div>

                <div class="config-row">
                    <label>Total de carnets:</label>
                    <strong id="totalToPrint">0</strong>
                </div>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button class="btn btn-success" onclick="generatePDF()">üìÑ Generar PDF</button>
                <button class="btn btn-info" onclick="printDirect()">üñ®Ô∏è Imprimir Directo</button>
                <button class="btn btn-primary" onclick="closeModal('printConfigModal')">Cerrar</button>
            </div>

            <h3 style="margin: 20px 0 10px 0; color: #1e3a8a;">Vista Previa (primeros 10)</h3>
            <div class="preview-grid" id="previewGrid"></div>
        </div>
    </div>

    <!-- Modal para configuraci√≥n de temas -->
    <div class="modal" id="themeConfigModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>üé® Configuraci√≥n de Temas</h2>
                <button class="close-btn" onclick="closeModal('themeConfigModal')">&times;</button>
            </div>
            
            <div style="padding: 20px;">
                <div class="form-group">
                    <label for="themeSelector" style="font-size: 16px; font-weight: 600; margin-bottom: 10px; display: block;">
                        Selecciona un tema visual:
                    </label>
                    <select id="themeSelector" onchange="changeTheme(event)" style="font-size: 16px; padding: 10px; width: 100%;">
                        <option value="default">üîµ Default (Azul ARCOR Original)</option>
                        <option value="oscuro">üåô Oscuro (Dark Mode)</option>
                        <option value="claro">‚òÄÔ∏è Claro (Light Minimalista)</option>
                        <option value="arcor">üè¢ ARCOR (Colores Corporativos)</option>
                    </select>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <h4 style="margin-bottom: 10px; color: #1e3a8a;">üìù Descripci√≥n de Temas:</h4>
                    <ul style="line-height: 1.8; padding-left: 20px;">
                        <li><strong>Default:</strong> Azul cl√°sico ARCOR, ideal para uso general</li>
                        <li><strong>Oscuro:</strong> Modo oscuro para trabajo nocturno, reduce fatiga visual</li>
                        <li><strong>Claro:</strong> Minimalista y limpio, m√°xima legibilidad</li>
                        <li><strong>ARCOR:</strong> Colores corporativos oficiales de ARCOR</li>
                    </ul>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid #10b981;">
                    <p style="margin: 0; color: #065f46;">
                        ‚ÑπÔ∏è <strong>Nota:</strong> El tema seleccionado se guarda autom√°ticamente y se aplicar√° cada vez que abras la aplicaci√≥n.
                    </p>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="closeModal('themeConfigModal')" style="padding: 12px 40px; font-size: 16px;">
                        ‚úÖ Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para nuevo carnet -->
    <div class="modal" id="newCarnetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Agregar Nuevo Carnet</h2>
                <button class="close-btn" onclick="closeModal('newCarnetModal')">&times;</button>
            </div>
            <form id="newCarnetForm" onsubmit="addNewCarnet(event)">
                <div class="form-group">
                    <label>Apellido *</label>
                    <input type="text" name="apellido" required>
                </div>
                <div class="form-group">
                    <label>Nombre *</label>
                    <input type="text" name="nombre" required>
                </div>
                <div class="form-group">
                    <label>DNI *</label>
                    <input type="text" name="dni" required>
                </div>
                <div class="form-group">
                    <label>Legajo *</label>
                    <input type="text" name="legajo" required>
                </div>
                <div class="form-group">
                    <label>Fecha de Calificaci√≥n *</label>
                    <input type="date" name="fecha_calificacion" required>
                </div>
                <div class="form-group">
                    <label>Fecha de Vencimiento *</label>
                    <input type="date" name="fecha_vencimiento" required>
                </div>
                <div class="form-group">
                    <label>Apto M√©dico *</label>
                    <select name="apto_medico" required>
                        <option value="">Seleccionar...</option>
                        <option value="Apto">Apto</option>
                        <option value="No Apto">No Apto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Foto del Conductor (opcional)</label>
                    <input type="file" id="photoInput" accept="image/*" onchange="previewPhoto(this)">
                    <div id="photoPreview" style="margin-top: 10px; display: none;">
                        <img id="photoPreviewImg" style="max-width: 100px; max-height: 120px; border: 2px solid #2563eb; border-radius: 5px;">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">Guardar</button>
                    <button type="button" class="btn btn-primary" onclick="closeModal('newCarnetModal')" style="flex: 1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para editar carnet -->
    <div class="modal" id="editCarnetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Editar Carnet</h2>
                <button class="close-btn" onclick="closeModal('editCarnetModal')">&times;</button>
            </div>
            <form id="editCarnetForm" onsubmit="updateCarnet(event)">
                <input type="hidden" id="edit_carnet_id">
                <div class="form-group">
                    <label>Apellido *</label>
                    <input type="text" id="edit_apellido" name="apellido" required>
                </div>
                <div class="form-group">
                    <label>Nombre *</label>
                    <input type="text" id="edit_nombre" name="nombre" required>
                </div>
                <div class="form-group">
                    <label>DNI *</label>
                    <input type="text" id="edit_dni" name="dni" required>
                </div>
                <div class="form-group">
                    <label>Legajo *</label>
                    <input type="text" id="edit_legajo" name="legajo" required>
                </div>
                <div class="form-group">
                    <label>Fecha de Calificaci√≥n *</label>
                    <input type="date" id="edit_fecha_calificacion" name="fecha_calificacion" required>
                </div>
                <div class="form-group">
                    <label>Fecha de Vencimiento *</label>
                    <input type="date" id="edit_fecha_vencimiento" name="fecha_vencimiento" required>
                </div>
                <div class="form-group">
                    <label>Apto M√©dico *</label>
                    <select id="edit_apto_medico" name="apto_medico" required>
                        <option value="">Seleccionar...</option>
                        <option value="Apto">Apto</option>
                        <option value="No Apto">No Apto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Foto del Conductor (opcional)</label>
                    <div id="edit_currentPhoto" style="margin-bottom: 10px; display: none;">
                        <p style="font-size: 12px; color: #6b7280;">Foto actual:</p>
                        <img id="edit_currentPhotoImg" style="max-width: 100px; max-height: 120px; border: 2px solid #2563eb; border-radius: 5px;">
                        <button type="button" class="btn btn-danger btn-small" onclick="removeEditPhoto()" style="display: block; margin-top: 5px;">üóëÔ∏è Eliminar foto</button>
                    </div>
                    <input type="file" id="edit_photoInput" accept="image/*" onchange="previewEditPhoto(this)">
                    <div id="edit_photoPreview" style="margin-top: 10px; display: none;">
                        <p style="font-size: 12px; color: #2563eb;">Nueva foto:</p>
                        <img id="edit_photoPreviewImg" style="max-width: 100px; max-height: 120px; border: 2px solid #2563eb; border-radius: 5px;">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">üíæ Actualizar</button>
                    <button type="button" class="btn btn-primary" onclick="closeModal('editCarnetModal')" style="flex: 1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let carnetsData = [];

        // Cargar datos del localStorage al iniciar
        window.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
            loadTheme();
            renderCarnets();
        });

        function loadFromLocalStorage() {
            const stored = localStorage.getItem('carnetsData');
            if (stored) {
                carnetsData = JSON.parse(stored);
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('carnetsData', JSON.stringify(carnetsData));
        }

        // ========== FUNCIONES DE TEMA CSS ==========
        
        function loadTheme() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'default';
            applyTheme(savedTheme);
            
            // Actualizar selector si existe
            const themeSelector = document.getElementById('themeSelector');
            if (themeSelector) {
                themeSelector.value = savedTheme;
            }
        }

        function applyTheme(themeName) {
            const themeLink = document.getElementById('theme-stylesheet');
            themeLink.href = `themes/${themeName}.css`;
            localStorage.setItem('selectedTheme', themeName);
        }

        function changeTheme(event) {
            const selectedTheme = event.target.value;
            applyTheme(selectedTheme);
        }

        function openThemeConfig() {
            document.getElementById('themeConfigModal').classList.add('active');
        }

        function openExcelUpload() {
            document.getElementById('excelModal').classList.add('active');
        }

        function openNewCarnetForm() {
            document.getElementById('newCarnetModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function loadExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                // Procesar datos del Excel
                carnetsData = jsonData.map((row, index) => ({
                    id: Date.now() + index,
                    apellido: row.Apellido || row.apellido || '',
                    nombre: row.Nombre || row.nombre || '',
                    dni: row.DNI || row.dni || '',
                    legajo: row.Legajo || row.legajo || '',
                    fecha_calificacion: row.Fecha_Calificacion || row.fecha_calificacion || '',
                    fecha_vencimiento: row.Fecha_Vencimiento || row.fecha_vencimiento || '',
                    apto_medico: row.Apto_Medico || row.apto_medico || 'Apto'
                }));

                saveToLocalStorage();
                renderCarnets();
                closeModal('excelModal');
                alert(`‚úÖ Se cargaron ${carnetsData.length} carnets exitosamente`);
            };
            reader.readAsArrayBuffer(file);
        }

        function addNewCarnet(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            // Obtener la foto si existe
            const photoInput = document.getElementById('photoInput');
            const photoData = photoInput.dataset.photoData || null;

            const newCarnet = {
                id: Date.now(),
                apellido: formData.get('apellido'),
                nombre: formData.get('nombre'),
                dni: formData.get('dni'),
                legajo: formData.get('legajo'),
                fecha_calificacion: formData.get('fecha_calificacion'),
                fecha_vencimiento: formData.get('fecha_vencimiento'),
                apto_medico: formData.get('apto_medico'),
                foto: photoData // Guardar la foto en base64
            };

            carnetsData.push(newCarnet);
            saveToLocalStorage();
            renderCarnets();
            
            // Descargar foto autom√°ticamente si existe
            if (photoData) {
                downloadPhotoFile(photoData, newCarnet.dni);
                alert('‚úÖ Carnet creado correctamente\n\nüì∏ Foto descargada como ' + newCarnet.dni + '.jpg\nüëâ Mu√©vela a la carpeta fotos/ para usarla con rutas relativas');
            }
            
            form.reset();
            document.getElementById('photoPreview').style.display = 'none';
            closeModal('newCarnetModal');
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // Si es formato DD/MM/YYYY
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            // Si es formato YYYY-MM-DD
            return new Date(dateStr);
        }

        function formatDate(dateStr) {
            const date = parseDate(dateStr);
            if (!date || isNaN(date)) return dateStr;
            return date.toLocaleDateString('es-AR');
        }

        function getStatus(vencimiento) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const vencDate = parseDate(vencimiento);
            
            if (!vencDate || isNaN(vencDate)) return 'unknown';
            
            const diffTime = vencDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) return 'expired';
            if (diffDays <= 30) return 'warning';
            return 'active';
        }

        function renderCarnets(filteredData = null) {
            const data = filteredData || carnetsData;
            const grid = document.getElementById('carnetsGrid');
            const noData = document.getElementById('noData');

            if (data.length === 0) {
                grid.innerHTML = '';
                noData.style.display = 'block';
                updateStats([]);
                return;
            }

            noData.style.display = 'none';
            
            grid.innerHTML = data.map(carnet => {
                const status = getStatus(carnet.fecha_vencimiento);
                const badgeClass = status === 'expired' ? 'badge-danger' : 
                                 status === 'warning' ? 'badge-warning' : 'badge-success';
                const badgeText = status === 'expired' ? 'Vencido' : 
                                status === 'warning' ? 'Por Vencer' : 'Vigente';

                // Mostrar foto si existe, sino emoji
                const photoHTML = carnet.foto 
                    ? `<img src="${carnet.foto}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">` 
                    : 'üë§';

                return `
                    <div class="carnet-card ${status}">
                        <div class="carnet-header">
                            <div class="photo-placeholder">${photoHTML}</div>
                            <div class="carnet-info">
                                <h3>${carnet.apellido}, ${carnet.nombre}</h3>
                                <p>DNI: ${carnet.dni}</p>
                                <span class="badge ${badgeClass}">${badgeText}</span>
                            </div>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Empresa:</span>
                            <span class="detail-value">ARCOR SAIC</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Legajo:</span>
                            <span class="detail-value">${carnet.legajo}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Fecha Calificaci√≥n:</span>
                            <span class="detail-value">${formatDate(carnet.fecha_calificacion)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Fecha Vencimiento:</span>
                            <span class="detail-value">${formatDate(carnet.fecha_vencimiento)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Apto M√©dico:</span>
                            <span class="detail-value">${carnet.apto_medico}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Autorizaci√≥n:</span>
                            <span class="detail-value">Autoelevador 2240 Kg</span>
                        </div>
                        <div class="print-buttons">
                            <button class="btn btn-info btn-small" onclick="printSingleCarnet(${carnet.id})">
                                üñ®Ô∏è Imprimir
                            </button>
                            <button class="btn btn-warning btn-small" onclick="editCarnet(${carnet.id})">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteCarnet(${carnet.id})">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            updateStats(data);
            updateAlerts(data);
        }

        function updateStats(data) {
            const total = data.length;
            const active = data.filter(c => getStatus(c.fecha_vencimiento) === 'active').length;
            const warning = data.filter(c => getStatus(c.fecha_vencimiento) === 'warning').length;
            const expired = data.filter(c => getStatus(c.fecha_vencimiento) === 'expired').length;

            document.getElementById('totalCarnets').textContent = total;
            document.getElementById('activeCount').textContent = active;
            document.getElementById('warningCount').textContent = warning;
            document.getElementById('expiredCount').textContent = expired;
        }

        function updateAlerts(data) {
            const alerts = data.filter(c => {
                const status = getStatus(c.fecha_vencimiento);
                return status === 'expired' || status === 'warning';
            });

            const alertsSection = document.getElementById('alertsSection');
            const alertsList = document.getElementById('alertsList');

            if (alerts.length === 0) {
                alertsSection.style.display = 'none';
                return;
            }

            alertsSection.style.display = 'block';
            alertsList.innerHTML = alerts.map(carnet => {
                const status = getStatus(carnet.fecha_vencimiento);
                const alertClass = status === 'expired' ? 'expired' : 'warning';
                const alertIcon = status === 'expired' ? 'üî¥' : '‚ö†Ô∏è';
                const alertText = status === 'expired' ? 'Carnet VENCIDO' : 'Vence pronto';

                return `
                    <div class="alert-item ${alertClass}">
                        <div>
                            <strong>${alertIcon} ${carnet.apellido}, ${carnet.nombre}</strong>
                            <p style="margin-top: 5px; color: #6b7280;">
                                ${alertText} - Vencimiento: ${formatDate(carnet.fecha_vencimiento)}
                            </p>
                        </div>
                        <span class="badge ${status === 'expired' ? 'badge-danger' : 'badge-warning'}">
                            ${status === 'expired' ? 'VENCIDO' : 'PR√ìXIMO A VENCER'}
                        </span>
                    </div>
                `;
            }).join('');
        }

        function filterCarnets() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            let filtered = carnetsData;

            if (searchTerm) {
                filtered = filtered.filter(c => 
                    c.nombre.toLowerCase().includes(searchTerm) ||
                    c.apellido.toLowerCase().includes(searchTerm) ||
                    c.dni.includes(searchTerm)
                );
            }

            if (statusFilter !== 'all') {
                filtered = filtered.filter(c => getStatus(c.fecha_vencimiento) === statusFilter);
            }

            renderCarnets(filtered);
        }

        function exportData() {
            if (carnetsData.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(carnetsData.map(c => ({
                Apellido: c.apellido,
                Nombre: c.nombre,
                DNI: c.dni,
                Legajo: c.legajo,
                Fecha_Calificacion: formatDate(c.fecha_calificacion),
                Fecha_Vencimiento: formatDate(c.fecha_vencimiento),
                Apto_Medico: c.apto_medico,
                Estado: getStatus(c.fecha_vencimiento) === 'expired' ? 'Vencido' : 
                       getStatus(c.fecha_vencimiento) === 'warning' ? 'Por Vencer' : 'Vigente'
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Carnets");
            XLSX.writeFile(wb, `carnets_arcor_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Event listeners para b√∫squeda en tiempo real
        document.getElementById('searchInput').addEventListener('input', filterCarnets);
        document.getElementById('statusFilter').addEventListener('change', filterCarnets);

        // ================== FUNCIONES DE IMPRESI√ìN ==================

        function openPrintConfig() {
            document.getElementById('printConfigModal').classList.add('active');
            updatePreview();
        }

        function getCarnetsToPrint() {
            const filter = document.getElementById('carnetsToPrint').value;
            
            if (filter === 'all') {
                return carnetsData;
            }
            
            return carnetsData.filter(c => getStatus(c.fecha_vencimiento) === filter);
        }

        function updatePreview() {
            const carnets = getCarnetsToPrint();
            const previewGrid = document.getElementById('previewGrid');
            const totalElement = document.getElementById('totalToPrint');
            
            totalElement.textContent = carnets.length;
            
            // Mostrar solo los primeros 10 en la vista previa
            const previewCarnets = carnets.slice(0, 10);
            
            previewGrid.innerHTML = previewCarnets.map(carnet => createCarnetPreviewHTML(carnet)).join('');
            
            if (carnets.length > 10) {
                previewGrid.innerHTML += `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #6b7280;">
                        ... y ${carnets.length - 10} carnets m√°s
                    </div>
                `;
            }
        }

        function createCarnetPreviewHTML(carnet) {
            const status = getStatus(carnet.fecha_vencimiento);
            const statusColor = status === 'expired' ? '#dc2626' : status === 'warning' ? '#f59e0b' : '#10b981';
            
            // Mostrar foto si existe, sino emoji
            const photoHTML = carnet.foto 
                ? `<img src="${carnet.foto}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 5px;">` 
                : 'üë§';
            
            return `
                <div class="carnet-preview" style="border-left: 3px solid ${statusColor}">
                    <div class="carnet-preview-header">
                        Chofer Autorizado para manejar autoelevador de 2240 Kg
                    </div>
                    <div class="carnet-preview-content">
                        <div class="carnet-preview-photo">${photoHTML}</div>
                        <div class="carnet-preview-info">
                            <p><strong>Empresa:</strong> ARCOR SAIC</p>
                            <p><strong>Apellido:</strong> ${carnet.apellido}</p>
                            <p><strong>Nombre:</strong> ${carnet.nombre}</p>
                            <p><strong>DNI:</strong> ${carnet.dni}</p>
                            <p><strong>Legajo:</strong> ${carnet.legajo}</p>
                            <p><strong>F. Calif.:</strong> ${formatDate(carnet.fecha_calificacion)}</p>
                            <p><strong>F. Venc.:</strong> ${formatDate(carnet.fecha_vencimiento)}</p>
                            <p><strong>Apto M√©dico:</strong> ${carnet.apto_medico}</p>
                        </div>
                    </div>
                    <div class="carnet-preview-footer">
                        Resoluci√≥n 960/2015 | AUTORIZADO POR LA EMPRESA
                    </div>
                </div>
            `;
        }

        function generatePDF() {
            console.log('üîµ generatePDF() llamada');
            
            // Validar que jsPDF est√© cargado
            if (typeof window.jspdf === 'undefined') {
                console.error('‚ùå jsPDF no cargado');
                alert('‚ùå Error: Librer√≠a de PDF no cargada.\n\nPor favor recarga la p√°gina.');
                return;
            }
            
            console.log('‚úÖ jsPDF cargado correctamente');

            try {
                const { jsPDF } = window.jspdf;
                const carnets = getCarnetsToPrint();
                const perPage = parseInt(document.getElementById('carnetsPerPage').value);
                const orientation = document.getElementById('pageOrientation').value;
                const includeLogo = document.getElementById('includeLogo').checked;
                
                console.log('üìä Configuraci√≥n:', { carnets: carnets.length, perPage, orientation, includeLogo });
                
                if (carnets.length === 0) {
                    alert('‚ö†Ô∏è No hay carnets para imprimir con los filtros seleccionados');
                    return;
                }

                const doc = new jsPDF({
                    orientation: orientation,
                    unit: 'mm',
                    format: 'a4'
                });
                
                console.log('üìÑ Documento PDF creado');

            const pageWidth = orientation === 'portrait' ? 210 : 297;
            const pageHeight = orientation === 'portrait' ? 297 : 210;
            const margin = 10;
            
            // Calcular dimensiones de cada carnet
            const cols = perPage <= 2 ? 1 : perPage <= 4 ? 2 : perPage <= 8 ? 2 : 2;
            const rows = Math.ceil(perPage / cols);
            
            const carnetWidth = (pageWidth - (margin * (cols + 1))) / cols;
            const carnetHeight = (pageHeight - (margin * (rows + 1))) / rows;

            let currentPage = 0;
            let currentPosition = 0;

            carnets.forEach((carnet, index) => {
                if (currentPosition >= perPage) {
                    doc.addPage();
                    currentPage++;
                    currentPosition = 0;
                }

                const col = currentPosition % cols;
                const row = Math.floor(currentPosition / cols);
                
                const x = margin + (col * (carnetWidth + margin));
                const y = margin + (row * (carnetHeight + margin));

                drawCarnet(doc, carnet, x, y, carnetWidth, carnetHeight, includeLogo);
                
                currentPosition++;
            });

            console.log('üíæ Guardando PDF...');
            doc.save(`carnets_arcor_${new Date().toISOString().split('T')[0]}.pdf`);
            console.log('‚úÖ PDF generado exitosamente');
            alert(`‚úÖ PDF generado con ${carnets.length} carnets`);
            
            } catch (error) {
                console.error('‚ùå Error al generar PDF:', error);
                alert('‚ùå Error al generar PDF: ' + error.message);
            }
        }

        function drawCarnet(doc, carnet, x, y, width, height, includeLogo) {
            // Borde del carnet
            doc.setDrawColor(0, 82, 163);
            doc.setLineWidth(0.8);
            doc.rect(x, y, width, height);

            // Header azul con t√≠tulo destacado
            doc.setFillColor(0, 82, 163);
            doc.rect(x, y, width, 12, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            const headerText = 'Chofer Autorizado para manejar autoelevador de 2240 Kg';
            doc.text(headerText, x + width/2, y + 8, { align: 'center' });

            // Foto - m√°s peque√±a y pegada a la izquierda
            const photoX = x + 5;
            const photoY = y + 17;
            const photoWidth = 30;
            const photoHeight = 40;
            
            if (carnet.foto) {
                try {
                    doc.addImage(carnet.foto, 'JPEG', photoX, photoY, photoWidth, photoHeight);
                } catch (e) {
                    // Si falla cargar la imagen, mostrar placeholder
                    doc.setFillColor(240, 240, 240);
                    doc.rect(photoX, photoY, photoWidth, photoHeight, 'F');
                    doc.setDrawColor(200, 200, 200);
                    doc.rect(photoX, photoY, photoWidth, photoHeight);
                }
            } else {
                // Foto placeholder
                doc.setFillColor(240, 240, 240);
                doc.rect(photoX, photoY, photoWidth, photoHeight, 'F');
                doc.setDrawColor(200, 200, 200);
                doc.rect(photoX, photoY, photoWidth, photoHeight);
            }

            // Logo ARCOR en c√≠rculo (DEBAJO de la foto)
            if (includeLogo) {
                const logoX = x + 20;
                const logoY = y + 62;
                doc.setFillColor(0, 82, 163);
                doc.circle(logoX, logoY, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(5);
                doc.setFont('helvetica', 'bold');
                doc.text('Grupo', logoX, logoY - 1, { align: 'center' });
                doc.setFontSize(6);
                doc.text('ARCOR', logoX, logoY + 2.5, { align: 'center' });
            }

            // √Årea blanca de informaci√≥n (a la derecha de la foto)
            doc.setFillColor(255, 255, 255);
            const infoBoxX = x + 40;
            const infoBoxY = y + 17;
            const infoBoxWidth = width - 45;
            const infoBoxHeight = 53;
            doc.rect(infoBoxX, infoBoxY, infoBoxWidth, infoBoxHeight, 'F');
            doc.setDrawColor(200, 200, 200);
            doc.rect(infoBoxX, infoBoxY, infoBoxWidth, infoBoxHeight);

            // Informaci√≥n del carnet con formato label: valor
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(8);
            
            let infoY = infoBoxY + 5;
            const labelX = infoBoxX + 2;
            const valueX = infoBoxX + 30;
            const lineHeight = 5.5;

            // Empresa
            doc.setFont('helvetica', 'bold');
            doc.text('Empresa:', labelX, infoY);
            doc.setFont('helvetica', 'normal');
            doc.text('ARCOR SAIC', valueX, infoY);
            
            // L√≠nea separadora
            doc.setDrawColor(220, 220, 220);
            doc.line(labelX, infoY + 1.2, infoBoxX + infoBoxWidth - 2, infoY + 1.2);
            infoY += lineHeight;

            // Apellido
            doc.setFont('helvetica', 'bold');
            doc.text('Apellido:', labelX, infoY);
            doc.setFont('helvetica', 'normal');
            doc.text(carnet.apellido, valueX, infoY);
            
            doc.setDrawColor(220, 220, 220);
            doc.line(labelX, infoY + 1.2, infoBoxX + infoBoxWidth - 2, infoY + 1.2);
            infoY += lineHeight;

            // Nombre
            doc.setFont('helvetica', 'bold');
            doc.text('Nombre:', labelX, infoY);
            doc.setFont('helvetica', 'normal');
            doc.text(carnet.nombre, valueX, infoY);
            
            doc.setDrawColor(220, 220, 220);
            doc.line(labelX, infoY + 1.2, infoBoxX + infoBoxWidth - 2, infoY + 1.2);
            infoY += lineHeight;

            // DNI
            doc.setFont('helvetica', 'bold');
            doc.text('DNI:', labelX, infoY);
            doc.setFont('helvetica', 'normal');
            doc.text(carnet.dni || '', valueX, infoY);
            
            doc.setDrawColor(220, 220, 220);
            doc.line(labelX, infoY + 1.2, infoBoxX + infoBoxWidth - 2, infoY + 1.2);
            infoY += lineHeight;

            // Legajo
            doc.setFont('helvetica', 'bold');
            doc.text('Legajo:', labelX, infoY);
            doc.setFont('helvetica', 'normal');
            doc.text(carnet.legajo || '', valueX, infoY);
            
            doc.setDrawColor(220, 220, 220);
            doc.line(labelX, infoY + 1.2, infoBoxX + infoBoxWidth - 2, infoY + 1.2);
            infoY += lineHeight;

            // Fecha de Calificaci√≥n
            doc.setFont('helvetica', 'bold');
            doc.text('Fecha de Calificaci√≥n:', labelX, infoY);
            doc.setFont('helvetica', 'normal');
            doc.text(formatDate(carnet.fecha_calificacion), labelX + 36, infoY);
            
            doc.setDrawColor(220, 220, 220);
            doc.line(labelX, infoY + 1.2, infoBoxX + infoBoxWidth - 2, infoY + 1.2);
            infoY += lineHeight;

            // Fecha de Vencimiento
            doc.setFont('helvetica', 'bold');
            doc.text('Fecha de Vencimiento:', labelX, infoY);
            doc.setFont('helvetica', 'normal');
            doc.text(formatDate(carnet.fecha_vencimiento), labelX + 38, infoY);
            
            doc.setDrawColor(220, 220, 220);
            doc.line(labelX, infoY + 1.2, infoBoxX + infoBoxWidth - 2, infoY + 1.2);
            infoY += lineHeight;

            // Apto M√©dico (sin l√≠nea al final)
            doc.setFont('helvetica', 'bold');
            doc.text('Apto M√©dico:', labelX, infoY);
            doc.setFont('helvetica', 'normal');
            doc.text(carnet.apto_medico, valueX, infoY);
        }

        function printDirect() {
            console.log('üñ®Ô∏è printDirect() llamada');
            
            // Validar que jsPDF est√© cargado
            if (typeof window.jspdf === 'undefined') {
                console.error('‚ùå jsPDF no cargado');
                alert('‚ùå Error: Librer√≠a de PDF no cargada.\n\nPor favor recarga la p√°gina.');
                return;
            }
            
            console.log('‚úÖ jsPDF cargado correctamente');

            try {
                const { jsPDF } = window.jspdf;
                const carnets = getCarnetsToPrint();
                const perPage = parseInt(document.getElementById('carnetsPerPage').value);
                const orientation = document.getElementById('pageOrientation').value;
                const includeLogo = document.getElementById('includeLogo').checked;
                
                console.log('üìä Configuraci√≥n:', { carnets: carnets.length, perPage, orientation, includeLogo });
                
                if (carnets.length === 0) {
                    alert('‚ö†Ô∏è No hay carnets para imprimir con los filtros seleccionados');
                    return;
                }

                const doc = new jsPDF({
                    orientation: orientation,
                    unit: 'mm',
                    format: 'a4'
                });
                
                console.log('üìÑ Documento PDF creado para impresi√≥n');

            const pageWidth = orientation === 'portrait' ? 210 : 297;
            const pageHeight = orientation === 'portrait' ? 297 : 210;
            const margin = 10;
            
            // Calcular dimensiones de cada carnet
            const cols = perPage <= 2 ? 1 : perPage <= 4 ? 2 : perPage <= 8 ? 2 : 2;
            const rows = Math.ceil(perPage / cols);
            
            const carnetWidth = (pageWidth - (margin * (cols + 1))) / cols;
            const carnetHeight = (pageHeight - (margin * (rows + 1))) / rows;

            let currentPage = 0;
            let currentPosition = 0;

            carnets.forEach((carnet, index) => {
                if (currentPosition >= perPage) {
                    doc.addPage();
                    currentPage++;
                    currentPosition = 0;
                }

                const col = currentPosition % cols;
                const row = Math.floor(currentPosition / cols);
                
                const x = margin + (col * (carnetWidth + margin));
                const y = margin + (row * (carnetHeight + margin));

                drawCarnet(doc, carnet, x, y, carnetWidth, carnetHeight, includeLogo);
                
                currentPosition++;
            });

            // Abrir en nueva ventana para imprimir
            console.log('üñ®Ô∏è Generando blob para impresi√≥n...');
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            
            console.log('ü™ü Abriendo ventana de impresi√≥n...');
            const printWindow = window.open(pdfUrl);
            
            if (printWindow) {
                printWindow.onload = function() {
                    console.log('‚úÖ Ventana cargada, activando di√°logo de impresi√≥n');
                    printWindow.print();
                };
            } else {
                console.warn('‚ö†Ô∏è Ventana emergente bloqueada');
                alert('‚ö†Ô∏è Por favor permite ventanas emergentes para imprimir directamente.\n\nAlternativamente usa el bot√≥n "Generar PDF".');
            }
            
            } catch (error) {
                console.error('‚ùå Error al imprimir:', error);
                alert('‚ùå Error al imprimir: ' + error.message);
            }
        }

        function printSingleCarnet(carnetId) {
            if (typeof window.jspdf === 'undefined') {
                alert('Error: Librer√≠a de PDF no cargada. Por favor recarga la p√°gina.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const carnet = carnetsData.find(c => c.id === carnetId);
            
            if (!carnet) {
                alert('Carnet no encontrado');
                return;
            }

            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            // Dibujar un solo carnet centrado en la p√°gina
            const carnetWidth = 85;
            const carnetHeight = 55;
            const x = (210 - carnetWidth) / 2;
            const y = 30;

            drawCarnet(doc, carnet, x, y, carnetWidth, carnetHeight, true);

            doc.save(`carnet_${carnet.apellido}_${carnet.nombre}.pdf`);
        }

        // Funci√≥n para imprimir r√°pidamente 10 carnets por hoja
        function printQuick10() {
            if (typeof window.jspdf === 'undefined') {
                alert('Error: Librer√≠a de PDF no cargada. Por favor recarga la p√°gina.');
                return;
            }

            if (carnetsData.length === 0) {
                alert('No hay carnets para imprimir. Por favor carga datos primero.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 10;
            const cols = 2;
            const rows = 5; // 2 columnas x 5 filas = 10 carnets
            
            const carnetWidth = (pageWidth - (margin * (cols + 1))) / cols;
            const carnetHeight = (pageHeight - (margin * (rows + 1))) / rows;

            let currentPage = 0;
            let currentPosition = 0;

            carnetsData.forEach((carnet, index) => {
                if (currentPosition >= 10) {
                    doc.addPage();
                    currentPage++;
                    currentPosition = 0;
                }

                const col = currentPosition % cols;
                const row = Math.floor(currentPosition / cols);
                
                const x = margin + (col * (carnetWidth + margin));
                const y = margin + (row * (carnetHeight + margin));

                drawCarnet(doc, carnet, x, y, carnetWidth, carnetHeight, true);
                
                currentPosition++;
            });

            doc.save(`carnets_arcor_10porHoja_${new Date().toISOString().split('T')[0]}.pdf`);
            alert(`‚úÖ PDF generado con ${carnetsData.length} carnets (10 por hoja)`);
        }

        // Funci√≥n para previsualizar la foto (nuevo carnet)
        function previewPhoto(input) {
            const preview = document.getElementById('photoPreview');
            const previewImg = document.getElementById('photoPreviewImg');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                    // Guardar la imagen en base64 para usarla despu√©s
                    input.dataset.photoData = e.target.result;
                };
                
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }

        // Funci√≥n para previsualizar la foto en modo edici√≥n
        function previewEditPhoto(input) {
            const preview = document.getElementById('edit_photoPreview');
            const previewImg = document.getElementById('edit_photoPreviewImg');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                    // Guardar la imagen en base64 para usarla despu√©s
                    input.dataset.photoData = e.target.result;
                };
                
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }

        // Funci√≥n para abrir modal de edici√≥n
        // Convertir fecha DD/MM/YYYY a YYYY-MM-DD para input type="date"
        function convertDateToInputFormat(dateStr) {
            if (!dateStr) return '';
            
            // Si ya est√° en formato YYYY-MM-DD, devolverla tal cual
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            
            // Si est√° en formato DD/MM/YYYY, convertir
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
                const parts = dateStr.split('/');
                return `${parts[2]}-${parts[1]}-${parts[0]}`; // YYYY-MM-DD
            }
            
            return dateStr;
        }

        function editCarnet(carnetId) {
            const carnet = carnetsData.find(c => c.id === carnetId);
            
            if (!carnet) {
                alert('Carnet no encontrado');
                return;
            }

            // Llenar el formulario con los datos actuales
            document.getElementById('edit_carnet_id').value = carnet.id;
            document.getElementById('edit_apellido').value = carnet.apellido;
            document.getElementById('edit_nombre').value = carnet.nombre;
            document.getElementById('edit_dni').value = carnet.dni;
            document.getElementById('edit_legajo').value = carnet.legajo;
            document.getElementById('edit_fecha_calificacion').value = convertDateToInputFormat(carnet.fecha_calificacion);
            document.getElementById('edit_fecha_vencimiento').value = convertDateToInputFormat(carnet.fecha_vencimiento);
            document.getElementById('edit_apto_medico').value = carnet.apto_medico;

            // Mostrar foto actual si existe
            const currentPhoto = document.getElementById('edit_currentPhoto');
            const currentPhotoImg = document.getElementById('edit_currentPhotoImg');
            const editPhotoInput = document.getElementById('edit_photoInput');
            
            if (carnet.foto) {
                currentPhotoImg.src = carnet.foto;
                currentPhoto.style.display = 'block';
                editPhotoInput.dataset.currentPhoto = carnet.foto;
            } else {
                currentPhoto.style.display = 'none';
                editPhotoInput.dataset.currentPhoto = '';
            }

            // Limpiar preview de nueva foto
            document.getElementById('edit_photoPreview').style.display = 'none';
            editPhotoInput.value = '';
            delete editPhotoInput.dataset.photoData;

            // Abrir modal
            document.getElementById('editCarnetModal').classList.add('active');
        }

        // Funci√≥n para actualizar carnet
        function updateCarnet(event) {
            event.preventDefault();
            const form = event.target;
            const carnetId = parseInt(document.getElementById('edit_carnet_id').value);

            // Obtener la foto: nueva si se subi√≥, actual si no se cambi√≥, o null si se elimin√≥
            const photoInput = document.getElementById('edit_photoInput');
            let photoData;
            
            if (photoInput.dataset.photoData) {
                // Nueva foto subida
                photoData = photoInput.dataset.photoData;
            } else if (photoInput.dataset.currentPhoto && photoInput.dataset.currentPhoto !== 'removed') {
                // Mantener foto actual
                photoData = photoInput.dataset.currentPhoto;
            } else {
                // Sin foto
                photoData = null;
            }

            const updatedCarnet = {
                id: carnetId,
                apellido: document.getElementById('edit_apellido').value,
                nombre: document.getElementById('edit_nombre').value,
                dni: document.getElementById('edit_dni').value,
                legajo: document.getElementById('edit_legajo').value,
                fecha_calificacion: document.getElementById('edit_fecha_calificacion').value,
                fecha_vencimiento: document.getElementById('edit_fecha_vencimiento').value,
                apto_medico: document.getElementById('edit_apto_medico').value,
                foto: photoData
            };

            // Encontrar y actualizar el carnet
            const index = carnetsData.findIndex(c => c.id === carnetId);
            if (index !== -1) {
                const oldCarnet = carnetsData[index];
                carnetsData[index] = updatedCarnet;
                saveToLocalStorage();
                renderCarnets();
                closeModal('editCarnetModal');
                
                // Descargar foto autom√°ticamente si se cambi√≥
                if (photoData && photoData !== oldCarnet.foto) {
                    downloadPhotoFile(photoData, updatedCarnet.dni);
                    alert('‚úÖ Carnet actualizado correctamente\n\nüì∏ Foto actualizada descargada como ' + updatedCarnet.dni + '.jpg\nüëâ Mu√©vela a la carpeta fotos/ para usarla con rutas relativas');
                } else {
                    alert('‚úÖ Carnet actualizado correctamente');
                }
            } else {
                alert('‚ùå Error al actualizar el carnet');
            }
        }

        // Funci√≥n para eliminar foto en modo edici√≥n
        function removeEditPhoto() {
            if (confirm('¬øEst√°s seguro de eliminar la foto actual?')) {
                const currentPhoto = document.getElementById('edit_currentPhoto');
                const photoInput = document.getElementById('edit_photoInput');
                
                currentPhoto.style.display = 'none';
                photoInput.dataset.currentPhoto = 'removed';
            }
        }

        // Funci√≥n para eliminar carnet
        function deleteCarnet(carnetId) {
            const carnet = carnetsData.find(c => c.id === carnetId);
            
            if (!carnet) {
                alert('Carnet no encontrado');
                return;
            }

            const confirmMsg = `¬øEst√°s seguro de eliminar el carnet de ${carnet.nombre} ${carnet.apellido}?\n\nEsta acci√≥n no se puede deshacer.`;
            
            if (confirm(confirmMsg)) {
                carnetsData = carnetsData.filter(c => c.id !== carnetId);
                saveToLocalStorage();
                renderCarnets();
                alert('‚úÖ Carnet eliminado correctamente');
            }
        }

        // ========== FUNCIONES PARA GESTI√ìN DE FOTOS EN CARPETA LOCAL ==========
        
        // Funci√≥n helper para descargar una foto individual
        function downloadPhotoFile(photoBase64, dni) {
            const link = document.createElement('a');
            link.href = photoBase64;
            link.download = `${dni}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Funci√≥n para descargar todas las fotos a una carpeta
        function downloadAllPhotos() {
            const carnetsWithPhotos = carnetsData.filter(c => c.foto);
            
            if (carnetsWithPhotos.length === 0) {
                alert('No hay carnets con fotos para descargar');
                return;
            }

            if (confirm(`Se descargar√°n ${carnetsWithPhotos.length} fotos.\n¬øContinuar?`)) {
                carnetsWithPhotos.forEach(carnet => {
                    const link = document.createElement('a');
                    link.href = carnet.foto;
                    link.download = `foto_${carnet.dni}_${carnet.apellido}_${carnet.nombre}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
                
                alert(`‚úÖ ${carnetsWithPhotos.length} fotos descargadas.\n\nGu√°rdalas en: carnets/fotos/\n\nRecomendaci√≥n: Renombra cada foto como DNI.jpg (ej: 12345678.jpg)`);
            }
        }

        // Funci√≥n para mostrar informaci√≥n sobre gesti√≥n de fotos
        function showPhotoManagementInfo() {
            const info = `
üì∏ GESTI√ìN DE FOTOS - Mejores Pr√°cticas

üîπ OPCI√ìN 1: Base64 (Actual)
‚úÖ Ventajas:
   - Todo en un archivo (index.html + localStorage)
   - F√°cil de compartir y respaldar
   - No requiere servidor web

‚ùå Desventajas:
   - L√≠mite de localStorage (~5-10 MB)
   - M√°s lento con muchas fotos
   - No recomendado para +50 carnets

üîπ OPCI√ìN 2: Carpeta Local (Recomendada para producci√≥n)
‚úÖ Ventajas:
   - Sin l√≠mite de tama√±o
   - Mejor rendimiento
   - Fotos organizadas

‚ùå Desventajas:
   - Requiere estructura de carpetas
   - Necesitas copiar fotos manualmente

üìÅ ESTRUCTURA RECOMENDADA:
carnets/
‚îú‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ fotos/
‚îÇ   ‚îú‚îÄ‚îÄ 12345678.jpg (DNI.jpg)
‚îÇ   ‚îú‚îÄ‚îÄ 87654321.jpg
‚îÇ   ‚îî‚îÄ‚îÄ ...

üîß PASOS PARA USAR CARPETA LOCAL:
1. Crea carpeta "fotos" junto a index.html
2. Nombra fotos como DNI.jpg (ej: 12345678.jpg)
3. El sistema buscar√° autom√°ticamente la foto

üí° CONSEJO:
- Para 1-20 carnets: Usa Base64 (actual)
- Para 20+: Usa carpeta local + respaldo
            `;
            
            alert(info);
        }
    </script>
</body>
</html>